/**
 * Removes unused legacy fields from the object table:
 * - offlineAvailableOwner
 * - isNew
 * - isUpdated
 *
 * @author nschaefli <ns@studer-raimann.ch>
 * @version 1.0.0
 */

import { View } from "typeorm/browser/schema-builder/view/View";
import {Migration, MigrationVersion} from "../services/migration/migration.api";
import {QueryRunner} from "typeorm/browser";

export class IntroduceViewLearnplaces implements Migration {

    readonly version: MigrationVersion = new MigrationVersion("V__13");

    async up(queryRunner: QueryRunner): Promise<void> {
        try {
            // sqlite does not support the ALTER TABLE "" DROP COLUMN ""; statement ...
            await queryRunner.query(
                `CREATE VIEW "learnplaces" AS
                SELECT "LearnplaceEntity"."id" AS "LearnplaceEntity_id", "LearnplaceEntity"."objectId" AS "LearnplaceEntity_objectId", "LearnplaceEntity"."FK_user" AS "LearnplaceEntity_FK_user", "LearnplaceEntity_location"."id" AS "LearnplaceEntity_location_id", "LearnplaceEntity_location"."latitude" AS "LearnplaceEntity_location_latitude", "LearnplaceEntity_location"."longitude" AS "LearnplaceEntity_location_longitude", "LearnplaceEntity_location"."elevation" AS "LearnplaceEntity_location_elevation", "LearnplaceEntity_location"."radius" AS "LearnplaceEntity_location_radius", "LearnplaceEntity_location"."FK_learnplace" AS "LearnplaceEntity_location_FK_learnplace", "LearnplaceEntity_map"."id" AS "LearnplaceEntity_map_id", "LearnplaceEntity_map"."zoom" AS "LearnplaceEntity_map_zoom", "LearnplaceEntity_map"."FK_visibility" AS "LearnplaceEntity_map_FK_visibility", "LearnplaceEntity_map"."FK_learnplace" AS "LearnplaceEntity_map_FK_learnplace", "LearnplaceEntity_map_visibility"."value" AS "LearnplaceEntity_map_visibility_value", "LearnplaceEntity_visitJournal"."id" AS "LearnplaceEntity_visitJournal_id", "LearnplaceEntity_visitJournal"."userId" AS "LearnplaceEntity_visitJournal_userId", "LearnplaceEntity_visitJournal"."time" AS "LearnplaceEntity_visitJournal_time", "LearnplaceEntity_visitJournal"."synchronized" AS "LearnplaceEntity_visitJournal_synchronized", "LearnplaceEntity_visitJournal"."FK_learnplace" AS "LearnplaceEntity_visitJournal_FK_learnplace", "LearnplaceEntity_accordionBlocks"."id" AS "LearnplaceEntity_accordionBlocks_id", "LearnplaceEntity_accordionBlocks"."iliasId" AS "LearnplaceEntity_accordionBlocks_iliasId", "LearnplaceEntity_accordionBlocks"."sequence" AS "LearnplaceEntity_accordionBlocks_sequence", "LearnplaceEntity_accordionBlocks"."title" AS "LearnplaceEntity_accordionBlocks_title", "LearnplaceEntity_accordionBlocks"."expanded" AS "LearnplaceEntity_accordionBlocks_expanded", "LearnplaceEntity_accordionBlocks"."FK_visibility" AS "LearnplaceEntity_accordionBlocks_FK_visibility", "LearnplaceEntity_accordionBlocks_visibility"."value" AS "LearnplaceEntity_accordionBlocks_visibility_value", "LearnplaceEntity_accordionBlocks_textBlocks"."id" AS "LearnplaceEntity_accordionBlocks_textBlocks_id", "LearnplaceEntity_accordionBlocks_textBlocks"."iliasId" AS "LearnplaceEntity_accordionBlocks_textBlocks_iliasId", "LearnplaceEntity_accordionBlocks_textBlocks"."sequence" AS "LearnplaceEntity_accordionBlocks_textBlocks_sequence", "LearnplaceEntity_accordionBlocks_textBlocks"."content" AS "LearnplaceEntity_accordionBlocks_textBlocks_content", "LearnplaceEntity_accordionBlocks_textBlocks"."FK_visibility" AS "LearnplaceEntity_accordionBlocks_textBlocks_FK_visibility", "LearnplaceEntity_accordionBlocks_textBlocks_visibility"."value" AS "LearnplaceEntity_accordionBlocks_textBlocks_visibility_value", "LearnplaceEntity_accordionBlocks_pictureBlocks"."id" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_id", "LearnplaceEntity_accordionBlocks_pictureBlocks"."iliasId" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_iliasId", "LearnplaceEntity_accordionBlocks_pictureBlocks"."sequence" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_sequence", "LearnplaceEntity_accordionBlocks_pictureBlocks"."title" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_title", "LearnplaceEntity_accordionBlocks_pictureBlocks"."description" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_description", "LearnplaceEntity_accordionBlocks_pictureBlocks"."thumbnail" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_thumbnail", "LearnplaceEntity_accordionBlocks_pictureBlocks"."thumbnailHash" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_thumbnailHash", "LearnplaceEntity_accordionBlocks_pictureBlocks"."url" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_url", "LearnplaceEntity_accordionBlocks_pictureBlocks"."hash" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_hash", "LearnplaceEntity_accordionBlocks_pictureBlocks"."FK_visibility" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_FK_visibility", "LearnplaceEntity_accordionBlocks_pictureBlocks_visibility"."value" AS "LearnplaceEntity_accordionBlocks_pictureBlocks_visibility_value", "LearnplaceEntity_accordionBlocks_linkBlocks"."id" AS "LearnplaceEntity_accordionBlocks_linkBlocks_id", "LearnplaceEntity_accordionBlocks_linkBlocks"."iliasId" AS "LearnplaceEntity_accordionBlocks_linkBlocks_iliasId", "LearnplaceEntity_accordionBlocks_linkBlocks"."sequence" AS "LearnplaceEntity_accordionBlocks_linkBlocks_sequence", "LearnplaceEntity_accordionBlocks_linkBlocks"."refId" AS "LearnplaceEntity_accordionBlocks_linkBlocks_refId", "LearnplaceEntity_accordionBlocks_linkBlocks"."FK_visibility" AS "LearnplaceEntity_accordionBlocks_linkBlocks_FK_visibility", "LearnplaceEntity_accordionBlocks_linkBlocks_visibility"."value" AS "LearnplaceEntity_accordionBlocks_linkBlocks_visibility_value", "LearnplaceEntity_accordionBlocks_videoBlocks"."id" AS "LearnplaceEntity_accordionBlocks_videoBlocks_id", "LearnplaceEntity_accordionBlocks_videoBlocks"."iliasId" AS "LearnplaceEntity_accordionBlocks_videoBlocks_iliasId", "LearnplaceEntity_accordionBlocks_videoBlocks"."sequence" AS "LearnplaceEntity_accordionBlocks_videoBlocks_sequence", "LearnplaceEntity_accordionBlocks_videoBlocks"."url" AS "LearnplaceEntity_accordionBlocks_videoBlocks_url", "LearnplaceEntity_accordionBlocks_videoBlocks"."hash" AS "LearnplaceEntity_accordionBlocks_videoBlocks_hash", "LearnplaceEntity_accordionBlocks_videoBlocks"."FK_visibility" AS "LearnplaceEntity_accordionBlocks_videoBlocks_FK_visibility", "LearnplaceEntity_accordionBlocks_videoBlocks_visibility"."value" AS "LearnplaceEntity_accordionBlocks_videoBlocks_visibility_value", "LearnplaceEntity_textBlocks"."id" AS "LearnplaceEntity_textBlocks_id", "LearnplaceEntity_textBlocks"."iliasId" AS "LearnplaceEntity_textBlocks_iliasId", "LearnplaceEntity_textBlocks"."sequence" AS "LearnplaceEntity_textBlocks_sequence", "LearnplaceEntity_textBlocks"."content" AS "LearnplaceEntity_textBlocks_content", "LearnplaceEntity_textBlocks"."FK_visibility" AS "LearnplaceEntity_textBlocks_FK_visibility", "LearnplaceEntity_textBlocks_visibility"."value" AS "LearnplaceEntity_textBlocks_visibility_value", "LearnplaceEntity_pictureBlocks"."id" AS "LearnplaceEntity_pictureBlocks_id", "LearnplaceEntity_pictureBlocks"."iliasId" AS "LearnplaceEntity_pictureBlocks_iliasId", "LearnplaceEntity_pictureBlocks"."sequence" AS "LearnplaceEntity_pictureBlocks_sequence", "LearnplaceEntity_pictureBlocks"."title" AS "LearnplaceEntity_pictureBlocks_title", "LearnplaceEntity_pictureBlocks"."description" AS "LearnplaceEntity_pictureBlocks_description", "LearnplaceEntity_pictureBlocks"."thumbnail" AS "LearnplaceEntity_pictureBlocks_thumbnail", "LearnplaceEntity_pictureBlocks"."thumbnailHash" AS "LearnplaceEntity_pictureBlocks_thumbnailHash", "LearnplaceEntity_pictureBlocks"."url" AS "LearnplaceEntity_pictureBlocks_url", "LearnplaceEntity_pictureBlocks"."hash" AS "LearnplaceEntity_pictureBlocks_hash", "LearnplaceEntity_pictureBlocks"."FK_visibility" AS "LearnplaceEntity_pictureBlocks_FK_visibility", "LearnplaceEntity_pictureBlocks_visibility"."value" AS "LearnplaceEntity_pictureBlocks_visibility_value", "LearnplaceEntity_linkBlocks"."id" AS "LearnplaceEntity_linkBlocks_id", "LearnplaceEntity_linkBlocks"."iliasId" AS "LearnplaceEntity_linkBlocks_iliasId", "LearnplaceEntity_linkBlocks"."sequence" AS "LearnplaceEntity_linkBlocks_sequence", "LearnplaceEntity_linkBlocks"."refId" AS "LearnplaceEntity_linkBlocks_refId", "LearnplaceEntity_linkBlocks"."FK_visibility" AS "LearnplaceEntity_linkBlocks_FK_visibility", "LearnplaceEntity_linkBlocks_visibility"."value" AS "LearnplaceEntity_linkBlocks_visibility_value", "LearnplaceEntity_videoBlocks"."id" AS "LearnplaceEntity_videoBlocks_id", "LearnplaceEntity_videoBlocks"."iliasId" AS "LearnplaceEntity_videoBlocks_iliasId", "LearnplaceEntity_videoBlocks"."sequence" AS "LearnplaceEntity_videoBlocks_sequence", "LearnplaceEntity_videoBlocks"."url" AS "LearnplaceEntity_videoBlocks_url", "LearnplaceEntity_videoBlocks"."hash" AS "LearnplaceEntity_videoBlocks_hash", "LearnplaceEntity_videoBlocks"."FK_visibility" AS "LearnplaceEntity_videoBlocks_FK_visibility", "LearnplaceEntity_videoBlocks_visibility"."value" AS "LearnplaceEntity_videoBlocks_visibility_value" FROM "Learnplace" "LearnplaceEntity" LEFT JOIN "Location" "LearnplaceEntity_location" ON "LearnplaceEntity_location"."FK_learnplace"="LearnplaceEntity"."id" LEFT JOIN "Map" "LearnplaceEntity_map" ON "LearnplaceEntity_map"."FK_learnplace"="LearnplaceEntity"."id" LEFT JOIN "Visibility" "LearnplaceEntity_map_visibility" ON "LearnplaceEntity_map_visibility"."value"="LearnplaceEntity_map"."FK_visibility" LEFT JOIN "VisitJournal" "LearnplaceEntity_visitJournal" ON "LearnplaceEntity_visitJournal"."FK_learnplace"="LearnplaceEntity"."id" LEFT JOIN "learnplace_accordion" "LearnplaceEntity_LearnplaceEntity_accordionBlocks" ON "LearnplaceEntity_LearnplaceEntity_accordionBlocks"."learnplaceId"="LearnplaceEntity"."id" LEFT JOIN "Accordion" "LearnplaceEntity_accordionBlocks" ON "LearnplaceEntity_accordionBlocks"."id"="LearnplaceEntity_LearnplaceEntity_accordionBlocks"."accordionId" LEFT JOIN "Visibility" "LearnplaceEntity_accordionBlocks_visibility" ON "LearnplaceEntity_accordionBlocks_visibility"."value"="LearnplaceEntity_accordionBlocks"."FK_visibility" LEFT JOIN "accordion_textblock" "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_textBlocks" ON "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_textBlocks"."accordionId"="LearnplaceEntity_accordionBlocks"."id" LEFT JOIN "TextBlock" "LearnplaceEntity_accordionBlocks_textBlocks" ON "LearnplaceEntity_accordionBlocks_textBlocks"."id"="LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_textBlocks"."textblockId" LEFT JOIN "Visibility" "LearnplaceEntity_accordionBlocks_textBlocks_visibility" ON "LearnplaceEntity_accordionBlocks_textBlocks_visibility"."value"="LearnplaceEntity_accordionBlocks_textBlocks"."FK_visibility" LEFT JOIN "accordion_pictureblock" "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_pictureBlocks" ON "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_pictureBlocks"."accordionId"="LearnplaceEntity_accordionBlocks"."id" LEFT JOIN "PictureBlock" "LearnplaceEntity_accordionBlocks_pictureBlocks" ON "LearnplaceEntity_accordionBlocks_pictureBlocks"."id"="LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_pictureBlocks"."pictureblockId" LEFT JOIN "Visibility" "LearnplaceEntity_accordionBlocks_pictureBlocks_visibility" ON "LearnplaceEntity_accordionBlocks_pictureBlocks_visibility"."value"="LearnplaceEntity_accordionBlocks_pictureBlocks"."FK_visibility" LEFT JOIN "accordion_linkblock" "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_linkBlocks" ON "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_linkBlocks"."accordionId"="LearnplaceEntity_accordionBlocks"."id" LEFT JOIN "LinkBlock" "LearnplaceEntity_accordionBlocks_linkBlocks" ON "LearnplaceEntity_accordionBlocks_linkBlocks"."id"="LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_linkBlocks"."linkblockId" LEFT JOIN "Visibility" "LearnplaceEntity_accordionBlocks_linkBlocks_visibility" ON "LearnplaceEntity_accordionBlocks_linkBlocks_visibility"."value"="LearnplaceEntity_accordionBlocks_linkBlocks"."FK_visibility" LEFT JOIN "accordion_videoblock" "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_videoBlocks" ON "LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_videoBlocks"."accordionId"="LearnplaceEntity_accordionBlocks"."id" LEFT JOIN "VideoBlock" "LearnplaceEntity_accordionBlocks_videoBlocks" ON "LearnplaceEntity_accordionBlocks_videoBlocks"."id"="LearnplaceEntity_accordionBlocks_LearnplaceEntity_accordionBlocks_videoBlocks"."videoblockId" LEFT JOIN "Visibility" "LearnplaceEntity_accordionBlocks_videoBlocks_visibility" ON "LearnplaceEntity_accordionBlocks_videoBlocks_visibility"."value"="LearnplaceEntity_accordionBlocks_videoBlocks"."FK_visibility" LEFT JOIN "learnplace_textblock" "LearnplaceEntity_LearnplaceEntity_textBlocks" ON "LearnplaceEntity_LearnplaceEntity_textBlocks"."learnplaceId"="LearnplaceEntity"."id" LEFT JOIN "TextBlock" "LearnplaceEntity_textBlocks" ON "LearnplaceEntity_textBlocks"."id"="LearnplaceEntity_LearnplaceEntity_textBlocks"."textblockId" LEFT JOIN "Visibility" "LearnplaceEntity_textBlocks_visibility" ON "LearnplaceEntity_textBlocks_visibility"."value"="LearnplaceEntity_textBlocks"."FK_visibility" LEFT JOIN "learnplace_pictureblock" "LearnplaceEntity_LearnplaceEntity_pictureBlocks" ON "LearnplaceEntity_LearnplaceEntity_pictureBlocks"."learnplaceId"="LearnplaceEntity"."id" LEFT JOIN "PictureBlock" "LearnplaceEntity_pictureBlocks" ON "LearnplaceEntity_pictureBlocks"."id"="LearnplaceEntity_LearnplaceEntity_pictureBlocks"."pictureblockId" LEFT JOIN "Visibility" "LearnplaceEntity_pictureBlocks_visibility" ON "LearnplaceEntity_pictureBlocks_visibility"."value"="LearnplaceEntity_pictureBlocks"."FK_visibility" LEFT JOIN "learnplace_linkblock" "LearnplaceEntity_LearnplaceEntity_linkBlocks" ON "LearnplaceEntity_LearnplaceEntity_linkBlocks"."learnplaceId"="LearnplaceEntity"."id" LEFT JOIN "LinkBlock" "LearnplaceEntity_linkBlocks" ON "LearnplaceEntity_linkBlocks"."id"="LearnplaceEntity_LearnplaceEntity_linkBlocks"."linkblockId" LEFT JOIN "Visibility" "LearnplaceEntity_linkBlocks_visibility" ON "LearnplaceEntity_linkBlocks_visibility"."value"="LearnplaceEntity_linkBlocks"."FK_visibility" LEFT JOIN "learnplace_videoblock" "LearnplaceEntity_LearnplaceEntity_videoBlocks" ON "LearnplaceEntity_LearnplaceEntity_videoBlocks"."learnplaceId"="LearnplaceEntity"."id" LEFT JOIN "VideoBlock" "LearnplaceEntity_videoBlocks" ON "LearnplaceEntity_videoBlocks"."id"="LearnplaceEntity_LearnplaceEntity_videoBlocks"."videoblockId" LEFT JOIN "Visibility" "LearnplaceEntity_videoBlocks_visibility" ON "LearnplaceEntity_videoBlocks_visibility"."value"="LearnplaceEntity_videoBlocks"."FK_visibility" as learnplaces`
            );
        } catch (error) {
            await queryRunner.rollbackTransaction();
            throw error;
        }
    }

    async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(
            "DROP VIEW learnplaces"
        );
    }
}
